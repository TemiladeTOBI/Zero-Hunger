<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="request.css">
</head>

<body id="body" class="element">
    <div id="navbar-wrapper">
        <div id="navbar">
            <div id="logo-wrapper" onmouseover="imgSwitch('navbar-logo','./logo/Zero-Hunger[blur].svg')"
                onmouseout="imgSwitch('navbar-logo','./logo/Zero-Hunger[blue].svg')">
                <a href="index.html">
                    <img id="navbar-logo" src="./logo/Zero-Hunger[blue].svg" alt="Zero Hunger Logo">
                </a>
            </div>
            <div id="trigger-div" onclick="toggleCollapsible()">
                <button onmouseover="imgSwitch('trigger-img', './icon/heart[white].svg')"
                    onmouseout="imgSwitch('trigger-img', './icon/heart.svg')">
                    <img id="trigger-img" src="./icon/heart.svg" alt="White Heart">
                </button>
            </div>
            <div id="collapsible-wrapper">
                <div id="theme-div">
                    <div class="element" onclick="switchTheme()">
                        <button id="theme-btn" class="element"></button>
                        <button class="underlay"></button>
                    </div>
                </div>
                <div id="nav-link-wrapper">
                    <div id="donate-request-wrapper">
                        <div id="requests-wrapper" class="nav-link-wrapper" onclick="viewRequests()"
                            onmouseover="viewRequests()">
                            <button id="your-requests-btn" class="nav-button" onclick="viewRequests()">Your
                                Requests</button>
                            <div id="requests-review" class="requests-review" popover="auto">
                                <div id="requests-select">
                                    <div id="select-btn-wrapper" class="btn-wrapper">
                                        <button id="pending-requests-btn" class="requests-select-btn"
                                            onclick="pendingUpdate()">Pending</button>
                                        <button id="succesful-requests-btn" class="requests-select-btn"
                                            onclick="succesfulUpdate()">Succesful</button>
                                    </div>
                                    <div id="action-btns-wrapper" class="btn-wrapper">
                                        <button id="submit-pending-btn" class="requests-select-btn"
                                            onclick="submitPending()">Confirm Pending</button>
                                        <button id="close-requests-btn" class="requests-select-btn"
                                            onclick="closeRequests()">Close</button>
                                    </div>
                                </div>
                                <div id="requests-display">

                                </div>
                            </div>
                        </div>
                        <div id="donate-wrapper" class="nav-link-wrapper" onclick="navDonate()"><a href="donate.html"
                                class="nav-link">Donate
                                Today</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="request-hero" class="element">
        <div id="request-form" class="request-sub-hero">
            <div id="request-form-header" class="element hero-header-wrapper">
                <h2>Request Form</h2>
            </div>
            <div class="element hero-form-wrapper">
                <form action="">
                    <div id="type-subdiv">
                        <label for="type-select">Type:</label>
                        <select name="food-type" id="type-select" required
                            onkeyup="enterTrigger(event, queryResultsUpdate)">
                            <option value="Rice">Rice</option>
                            <option value="Spaghetti">Spaghetti</option>
                            <option value="Noodles">Noodles</option>
                            <option value="Beans">Beans</option>
                            <option value="Flour">Flour</option>
                            <option value="Semo">Semo</option>
                            <option value="Gaari">Gaari</option>
                            <option value="Yam">Yam</option>
                            <option value="Potatoes">Potatoes</option>
                            <option value="Vegetables">Vegetables</option>
                            <option value="Fruits">Fruits</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Salt">Salt</option>
                            <option value="Sugar">Sugar</option>
                            <option value="Seasoning or Spices">Seasoning or Spices</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Palm Oil">Palm Oil</option>
                            <option value="Vegetable Oil">Vegetable Oil</option>
                            <option value="Groundnut Oil">Groundnut Oil</option>
                            <option value="Other">Other(specify in Additional Info)</option>
                        </select>
                    </div>
                    <div id="unit-subdiv">
                        <label for="unit-select">Units:</label>
                        <select name="food-unit" id="unit-select" required
                            onkeyup="enterTrigger(event, queryResultsUpdate)">
                            <option value="Pieces">Pieces</option>
                            <option value="Kilograms">Kilograms</option>
                            <option value="Cups">Cups</option>
                            <option value="Bowls">Bowls</option>
                            <option value="Bags">Bags</option>
                            <option value="Sacks">Sacks</option>
                            <option value="Packs">Packs</option>
                            <option value="Sachets">Sachets</option>
                            <option value="Bottles">Bottles</option>
                            <option value="Tubers">Tubers</option>
                            <option value="Other">Other(specify in Additional Info)</option>
                        </select>
                    </div>
                    <div id="amount-subdiv">
                        <label for="amount-input">Minimum Amount:</label>
                        <input type="number" name="food-amount" id="amount-input" step="1" min="1" required
                            onkeyup="enterTrigger(event, queryResultsUpdate)">
                    </div>
                    <div id="pickup-subdiv" class="textarea-subdiv">
                        <label for="pickup-textarea">Closest Location:</label>
                        <textarea name="pickup-location" id="pickup-textarea"
                            placeholder="Make use of landmark keywords!"
                            onkeyup="enterTrigger(event, queryResultsUpdate)"></textarea>
                    </div>
                </form>
                <div id="button-div">
                    <button id="search-btn" onclick="queryResultsUpdate()">Search</button>
                    <button id="reset-btn" onclick="formReset('#request-form')">Reset</button>
                </div>
            </div>
        </div>
        <div id="request-results" class="request-sub-hero">
            <div id="request-results-header" class="element hero-header-wrapper">
                <h2>Search Results</h2>
            </div>
            <div id="request-results-wrapper" class="element hero-form-wrapper">

            </div>
        </div>
    </div>

    <div id="modals">
        <dialog id="logo-dialog" class="popover">
            <div id="logo-header" class="popover-header">
                <h2>The Zero-Hunger Logo</h2>
                <button onmouseover="crossHover('sign-in-button-cross')" onmouseout="crossReset('sign-in-button-cross')"
                    onclick="hideDialog('logo-dialog')">
                    <img id="sign-in-button-cross" src="./icon/cross.svg" alt="Cross button"
                        onmouseover="crossHover('sign-in-button-cross')"
                        onmouseout="crossReset('sign-in-button-cross')">
                </button>
            </div>
            <div id="logo-body" class="popover-body">
                <div id="logo-body-img-wrapper">
                    <img src="./logo/Zero-Hunger[blue].svg" alt="Zero-Hunger logo">
                </div>
                <div id="logo-body-txt-wrapper">
                    <p><strong>Seedling:</strong> The seedling reminds us that every gift given and every prayer said
                        are seeds planted into a lives. Regularly watered and tended with time, these lives will grow to
                        yield fruit and give back into other lives.</p>
                    <p><strong>Heart:</strong>The heart is reminiscent of breaking bread - selflessly sharing with the
                        needy. The foundation on which Zero-Hunger was born.</p>
                </div>
            </div>
        </dialog>
        <dialog id="mission-dialog" class="popover">
            <div id="mission-header" class="popover-header">
                <h2>Zero-Hunger's Mission</h2>
                <button onmouseover="crossHover('sign-in-button-cross')" onmouseout="crossReset('sign-in-button-cross')"
                    onclick="hideDialog('mission-dialog')">
                    <img id="sign-in-button-cross" src="./icon/cross.svg" alt="Cross button"
                        onmouseover="crossHover('sign-in-button-cross')"
                        onmouseout="crossReset('sign-in-button-cross')">
                </button>
            </div>
            <div id="mission-body" class="popover-body"></div>
        </dialog>
        <dialog id="vision-dialog" class="popover">
            <div id="vision-header" class="popover-header">
                <h2>The Zero-Hunger Vision</h2>
                <button onmouseover="crossHover('sign-in-button-cross')" onmouseout="crossReset('sign-in-button-cross')"
                    onclick="hideDialog('vision-dialog')">
                    <img id="sign-in-button-cross" src="./icon/cross.svg" alt="Cross button"
                        onmouseover="crossHover('sign-in-button-cross')"
                        onmouseout="crossReset('sign-in-button-cross')">
                </button>
            </div>
            <div id="vision-body" class="popover-body"></div>
        </dialog>
    </div>

    <div id="further">
        <ul>
            <li class="ul-header">Know more about us</li>
            <li onclick="showDialog('logo-dialog')"><a href="#">Our Logo</a></li>
            <li onclick="showDialog('mission-dialog')"><a href="#">Our Mission</a></li>
            <li onclick="showDialog('vision-dialog')"><a href="#">Our Vision</a></li>
        </ul>
        <ul>
            <li class="ul-header">Take action</li>
            <li><a href="donate.html">Donate</a></li>
        </ul>
        <ul>
            <li class="ul-header">Reach out to us</li>
            <li><a href=""><span class="icon-span"></span>Twitter</a></li>
            <li><a href=""><span class="icon-span"></span>Facebook</a></li>
            <li><a href=""><span class="icon-span"></span>Instagram</a></li>
            <li><a href=""><span class="icon-span"></span>YouTube</a></li>
            <li><a href=""><span class="icon-span"></span>9gag</a></li>
        </ul>
    </div>

    <footer>
        2025 © Zero-Hunger
    </footer>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Authentication
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";


        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAd4UJcWg4hMkvWCFS2LB_f5J0X_eKuAX4",
            authDomain: "zero-hunger-b8414.firebaseapp.com",
            projectId: "zero-hunger-b8414",
            storageBucket: "zero-hunger-b8414.firebasestorage.app",
            messagingSenderId: "361960148895",
            appId: "1:361960148895:web:30eb932276b7c4e3a237aa",
            measurementId: "G-HJST5LWVV6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Auth
        const provider = new GoogleAuthProvider();
        const auth = getAuth();
        let currentUser, currentUserUID;
        let succesfulRequests;

        const signUserOut = () => {
            signOut(auth).then(() => {
                // Sign-out successful.
                window.location.href = "index.html";
            }).catch((error) => {
                // An error happened.
                console.log(error);
            });
        };

        const checkCurrentUser = (() => {   /* Fetch Current User */
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, see docs for a list of available properties
                    // https://firebase.google.com/docs/reference/js/auth.user

                    currentUser = user;
                    currentUserUID = user.uid;
                    loadUserNav();
                    fetchUserRequests();
                    // ...
                } else {
                    // User is signed out
                    console.log("No user!");
                    forceCurrentUser();
                    // ...
                }
            });
        })();

        const forceCurrentUser = () => {    /* Force-check User */
            if (currentUser == undefined) {
                window.location.href = "index.html";
                sessionStorage.redirectStatus = "true";
            }
        };

        const fetchUserRequests = () => {
            const db = getDatabase();
            onValue(ref(db, `Requests-${currentUserUID}`), (snapshot) => {
                const data = snapshot.val();

                succesfulRequests = Object.values(data);
                console.log("fetchedUserRequests:", succesfulRequests);
            });
        };


        const loadUserNav = () => { /* Check current user, to load navbar details */
            const navLinkWrapper = document.getElementById("nav-link-wrapper");

            if (currentUser != undefined) {
                let avatarSrc;  /* User Avatar Image Source */
                let displayName;    /* User Name String */

                if ((typeof (currentUser.photoURL)) != "string") {
                    avatarSrc = "./icon/heart.svg";
                } else {
                    avatarSrc = currentUser.photoURL;
                }
                

                if ((typeof (currentUser.displayName)) != "string") {
                    displayName = currentUser.email;
                    const atIndex = displayName.indexOf('@');

                    displayName = displayName.slice(0, atIndex);    /* Clean up Username */
                } else {
                    displayName = currentUser.displayName;
                }

                // Load User Details
                navLinkWrapper.innerHTML += `<div id="user-div" onmouseover="showPopunder('user-details-popunder')" onclick="showPopunder('user-details-popunder')">
                <div id="user-details-popunder" class="popunder" onfocus="showPopunder('user-details-popunder')">
                    <p class="popunder-mail"><b>Email: </b>${currentUser.email}</p>
                    <p class="popunder-out"><a href="#" onclick="hidePopunder('user-details-popunder')"">Close</a>
                    <a href="#" onclick="signUserOut()">Sign Out</a></p>
                </div>
                <div id="user-avatar-wrapper">
                    <img src="${avatarSrc}" alt="User Avatar">
                </div>
                <div id="user-details">
                    <p id="user-name">${displayName}</p>
                    <p id="user-status"><span id="user-staus-icon"></span> Signed-In</p>
                </div>
            </div>`
            }
            else {
                console.log("No CurrentUser!");

                // Load Sign-In/Log-In instead
                navLinkWrapper.innerHTML += `<div id="sign-in-wrapper">
                <button id="sign-in-button" onclick="showDialog('sign-up-dialog')">Sign In</button>
            </div>`
            }
        };
        

        window.checkCurrentUser = checkCurrentUser;
        window.forceCurrentUser = forceCurrentUser;
        window.loadUserNav = loadUserNav;


        import { getDatabase, ref, set, child, push, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Initialize Realtime Database and get a reference to the service
        const database = getDatabase(app);
        let succesfulDonations;
        let queryResults = [];

        // Donations Display
        const placeholderHTML = `<div id="placeholder-div">
                                        <div>
                                            <img id="placeholder-icon" src="./icon/heart.svg" alt="Loading Icon">
                                        </div>
                                        <p>Fetching...</p>
                                    </div>`;

        const fetchDonations = () => {
            const db = getDatabase();
            onValue(ref(db, 'Donations'), (snapshot) => {
                const data = snapshot.val();

                succesfulDonations = Object.values(data);
                console.log("succesfulDonations:", succesfulDonations);
            });
            return succesfulDonations;
        };

        // Request Query Object creation
        const typeSelect = document.getElementById("type-select");
        const unitSelect = document.getElementById("unit-select");
        const amountInput = document.getElementById("amount-input");
        const pickupTextarea = document.getElementById("pickup-textarea");
        const searchBtn = document.getElementById("search-btn");
        const resetBtn = document.getElementById("reset-btn");

        class requestQuery {  /* Class declaration */
            constructor() {
                this.type = typeSelect.value;
                this.unit = unitSelect.value;
                this.amount = amountInput.value;
                this.location = pickupTextarea.value;
            }
        }

        const createQuery = () => {   /* Class object creation */
            const requestQueryObj = new requestQuery;
            return requestQueryObj;
        }

        const writeRequest = (requestObj) => {
            const db = getDatabase();
            set(push(ref(db, `Requests`)), {   /* Write request to general DB */
                succesfulRequest: requestObj
            });
            set(push(ref(db, `Requests-${currentUserUID}`)), {   /* Write request to user DB */
                succesfulRequest: requestObj
            });
        };

        const donationSearch = () => {  /* Array filter algorithm */
            const requestQueryObj = createQuery();
            queryResults = fetchDonations();

            switch (true) {
                case ((requestQueryObj.type != "") && (queryResults != undefined)):  /* Filter array by type */
                    queryResults = succesfulDonations.filter((value) => { return value.succesfulDonation.type == requestQueryObj.type });
                    console.log('by type:', queryResults);


                case ((requestQueryObj.unit != "") && (queryResults != []) && (queryResults != undefined)):  /* Filter array by unit */
                    if ((requestQueryObj.unit != "") && (queryResults != [])) {
                        queryResults = queryResults.filter((value) => { return value.succesfulDonation.unit == requestQueryObj.unit });
                    };

                case ((requestQueryObj.amount != "") && (queryResults != []) && (queryResults != undefined)):  /* Filter array by amount */
                    if ((requestQueryObj.amount != "") && (queryResults != [])) {
                        queryResults = queryResults.filter((value) => { return parseInt(value.succesfulDonation.amount) >= parseInt(requestQueryObj.amount) });
                    };

                case ((requestQueryObj.location.trim() != "") && (queryResults != []) && (queryResults != undefined)):  /* Filter array by location */
                    if ((requestQueryObj.location.trim() != "") && (queryResults != [])) {
                        queryResults = queryResults.filter((value) => { return value.succesfulDonation.location.search(requestQueryObj.location) != -1 });
                    };
                    break;

                default:
                    queryResults = fetchDonations();
                    break;
            }

            return queryResults;
        }

        const queryResultsDisplay = (queryArray = queryResults) => {    /* Display argument as Search Results*/
            document.getElementById("request-results-wrapper").innerHTML = placeholderHTML;  /* Display placeholder */

            if (queryArray == undefined) {
                setTimeout(() => {
                    queryResultsUpdate();
                }, 1000);
            } else {
                if (queryArray.length == 0) {
                    // Query filter returns null
                    document.getElementById("request-results-wrapper").innerHTML = `<div id="no-results">
                <p>No available donations match criteria!</p>
                <div>
                    <img src="./icon/heartbroken.svg" alt="Heartbroken">
                </div>
            </div>`;
                } else {
                    document.getElementById("request-results-wrapper").innerHTML = "";  /* Clear display */

                    for (let i = 0; i < queryArray.length; i++) {
                        document.getElementById("request-results-wrapper").innerHTML += `<div id="result${i}" class="request-card">
                    <p><b>Food Type: </b>${queryArray[i].succesfulDonation.type}</p>
                    <p><b>Unit Type: </b>${queryArray[i].succesfulDonation.unit}</p>
                    <p><b>Amount: </b>${queryArray[i].succesfulDonation.amount}</p>
                    <p><b>Pick-up Location: </b>${queryArray[i].succesfulDonation.location}</p>
                    <p><b>Additional Information: </b>${queryArray[i].succesfulDonation.addInfo}</p>
                    <button onclick="addPendingRequest(${i})">Request</button>
                </div>`;
                    }

                    window.location.href = "#request-results"   /* Navigate to results */
                }
            }
        }

        const verifyPendingRequest = (pendingRequest) => {   /* Check for duplicate requests */
            const verifyStatus = pendingRequests.findIndex((request) => {
                return (request.succesfulDonation.type == pendingRequest.succesfulDonation.type
                    && request.succesfulDonation.unit == pendingRequest.succesfulDonation.unit
                    && request.succesfulDonation.amount == pendingRequest.succesfulDonation.amount
                    && request.succesfulDonation.location == pendingRequest.succesfulDonation.location
                    && request.succesfulDonation.addInfo == pendingRequest.succesfulDonation.addInfo
                );
            })

            return verifyStatus;
        }

        const queryResultsUpdate = () => { /* Display filter results */
            queryResults = donationSearch();  /* Generate results */

            queryResultsDisplay(queryResults);  /* Display results */
        }

        const addPendingRequest = (i) => {   /* Add selected donation to pending requests*/
            if (verifyPendingRequest(queryResults[i]) <= -1) {
                pendingRequests.push(queryResults[i]);
                queryResults.splice(i, 1);   /* Splice donation to avoid redundant selection */
                queryResultsDisplay();  /* Then update display */
            } else {
                showPopup("duplicate-warning", "Duplicate Request!")
            }


            badgeUpdate("requests-badge", "requests-wrapper");  /* Update badge */

            console.log("pendingRequests:", pendingRequests, "queryResults:", queryResults);
        }

        const succesfulUpdate = () => {   /* Display succesful requests */
            let requestsDisplay = document.getElementById("requests-display"); /* Refresh HTML Element */
            requestsDisplay.innerHTML = placeholderHTML;

            if (succesfulRequests == undefined) {
                setTimeout(() => {
                    succesfulUpdate();
                }, 1000);
            } else {
                requestsDisplay.innerHTML = "" /* Clear display */

                for (let i = 0; i < succesfulRequests.length; i++) {
                    requestsDisplay = document.getElementById("requests-display"); /* Refresh HTML Element */

                    requestsDisplay.innerHTML += `<div id="succesful${i}" class="request-card">
                                <p><b>Food Type: </b>${succesfulRequests[i].succesfulRequest.type}</p>
                                <p><b>Unit Type: </b>${succesfulRequests[i].succesfulRequest.unit}</p>
                                <p><b>Amount: </b>${succesfulRequests[i].succesfulRequest.amount}</p>
                                <p><b>Pick-up Location: </b>${succesfulRequests[i].succesfulRequest.location}</p>
                                <p><b>Additional Information: </b>${succesfulRequests[i].succesfulRequest.addInfo}</p>
                            </div>`;
                }

                let succesfulRequestsBtn = document.getElementById("succesful-requests-btn"); /* Refresh HTML Element */
                succesfulRequestsBtn.classList.add("requests-active-btn");   /* Make button "active"*/

                let pendingRequestsBtn = document.getElementById("pending-requests-btn"); /* Refresh HTML Element */
                pendingRequestsBtn.classList.remove("requests-active-btn");    /* "Deactivate" opposing button */
            }
        }


        class succesfulRequest {   /* Succesful request class declaration */
            constructor(type, unit, amount, location, addInfo) {
                this.type = type;
                this.unit = unit;
                this.amount = amount;
                this.location = location;
                this.addInfo = addInfo;
            }
        }

        const submitPending = () => {   /* Submit pending requests */
            if (pendingRequests.length != 0) {
                for (let i = 0; i < pendingRequests.length; i++) {
                    const pendingRequest = pendingRequests[i];

                    const succesfulRequestObj = new succesfulRequest(pendingRequest.succesfulDonation.type, pendingRequest.succesfulDonation.unit, pendingRequest.succesfulDonation.amount, pendingRequest.succesfulDonation.location, pendingRequest.succesfulDonation.addInfo);
                    writeRequest(succesfulRequestObj);
                }

                succesfulUpdate();

                pendingRequests = [];  /* Empty pending array */
                badgeClear("requests-badge");
            } else {
                console.log("No pending!");
            }
        }

        // Reset Form Values
        const formReset = (destination = "#navbar") => {
            typeSelect.value = "";
            unitSelect.value = "";
            amountInput.value = "";
            pickupTextarea.value = "";

            window.location.href = destination; /* Navigate to destination */
        }
        formReset();


        window.signUserOut = signUserOut;
        window.fetchDonations = fetchDonations;
        window.writeRequest = writeRequest;
        window.donationSearch = donationSearch;
        window.queryResultsDisplay = queryResultsDisplay;
        window.queryResultsUpdate = queryResultsUpdate;
        window.addPendingRequest = addPendingRequest;
        window.submitPending = submitPending;
        window.succesfulUpdate = succesfulUpdate;
        window.formReset = formReset;
    </script>
    <script src="script.js"></script>
    <script src="request.js"></script>
</body>

</html>