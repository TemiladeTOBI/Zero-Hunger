<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="donate.css">
</head>

<body id="body" class="element">
    <div id="navbar-wrapper">
        <div id="navbar">
            <div id="logo-wrapper" onmouseover="imgSwitch('navbar-logo','./logo/Zero-Hunger[blur].svg')"
                onmouseout="imgSwitch('navbar-logo','./logo/Zero-Hunger[blue].svg')">
                <a href="index.html">
                    <img id="navbar-logo" src="./logo/Zero-Hunger[blue].svg" alt="Zero Hunger Logo">
                </a>
            </div>
            <div id="trigger-div" onclick="toggleCollapsible()">
                <button onmouseover="imgSwitch('trigger-img', './icon/heart[white].svg')"
                    onmouseout="imgSwitch('trigger-img', './icon/heart.svg')">
                    <img id="trigger-img" src="./icon/heart.svg" alt="White Heart">
                </button>
                <!-- <span id="trigger-badge">!</span> -->
            </div>
            <div id="collapsible-wrapper">
                <div id="theme-div">
                    <div class="element" onclick="switchTheme()">
                        <button id="theme-btn" class="element"></button>
                        <button class="underlay"></button>
                    </div>
                </div>
                <div id="nav-link-wrapper">
                    <div id="donate-request-wrapper">
                        <div id="donate-wrapper" class="nav-link-wrapper" onclick="viewDonations()"
                            onmouseover="viewDonations()">
                            <button id="your-donations-btn" class="nav-button" onclick="viewDonations()">Your
                                Donations</button>
                            <div id="donations-review" class="donations-review donations-review-hidden">
                                <div id="donation-select">
                                    <div id="select-btn-wrapper" class="btn-wrapper">
                                        <button id="pending-donation-btn" class="donation-select-btn"
                                            onclick="pendingUpdate()">Pending</button>
                                        <button id="succesful-donation-btn" class="donation-select-btn"
                                            onclick="succesfulUpdate()">Succesful</button>
                                    </div>
                                    <div id="action-btns-wrapper" class="btn-wrapper">
                                        <button id="submit-pending-btn" class="donation-select-btn"
                                            onclick="submitPending()">Confirm Pending</button>
                                        <button id="close-donation-btn" class="donation-select-btn"
                                            onclick="closeDonations()">Close</button>
                                    </div>
                                </div>
                                <div id="donation-display"></div>
                            </div>
                        </div>
                        <div id="receive-wrapper" class="nav-link-wrapper" onclick="navRequest()"><a href="request.html"
                                class="nav-link">Make a
                                Request</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="donate-hero" class="element">
        <div id="hero-header-wrapper" class="element">
            <div id="hero-header-text-wrapper">
                <h2>DONATION FORM</h2>
            </div>
        </div>
        <div id="hero-form-wrapper" class="element">
            <form action="">
                <div id="type-subdiv">
                    <label for="type-select">Type:</label>
                    <select name="food-type" id="type-select" required>
                        <option value="Rice">Rice</option>
                        <option value="Spaghetti">Spaghetti</option>
                        <option value="Noodles">Noodles</option>
                        <option value="Beans">Beans</option>
                        <option value="Flour">Flour</option>
                        <option value="Semo">Semo</option>
                        <option value="Gaari">Gaari</option>
                        <option value="Yam">Yam</option>
                        <option value="Potatoes">Potatoes</option>
                        <option value="Vegetables">Vegetables</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Salt">Salt</option>
                        <option value="Sugar">Sugar</option>
                        <option value="Seasoning or Spices">Seasoning or Spices</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Palm Oil">Palm Oil</option>
                        <option value="Vegetable Oil">Vegetable Oil</option>
                        <option value="Groundnut Oil">Groundnut Oil</option>
                        <option value="Other">Other(specify in Additional Info)</option>
                    </select>
                </div>
                <div id="unit-subdiv">
                    <label for="unit-select">Unit:</label>
                    <select name="food-unit" id="unit-select" required>
                        <option value="Pieces">Pieces</option>
                        <option value="Kilograms">Kilograms</option>
                        <option value="Cups">Cups</option>
                        <option value="Bowls">Bowls</option>
                        <option value="Bags">Bags</option>
                        <option value="Sacks">Sacks</option>
                        <option value="Packs">Packs</option>
                        <option value="Sachets">Sachets</option>
                        <option value="Bottles">Bottles</option>
                        <option value="Tubers">Tubers</option>
                        <option value="Other">Other(specify in Additional Info)</option>
                    </select>
                </div>
                <div id="amount-subdiv">
                    <label for="amount-input">Amount:</label>
                    <input type="number" name="food-amount" id="amount-input" step="1" min="1" value="5" required>
                </div>
                <div id="pickup-subdiv" class="textarea-subdiv">
                    <label for="pickup-textarea">Pick-up Location:</label>
                    <textarea name="pickup-location" id="pickup-textarea" placeholder="Make use of landmark keywords!"
                        required>value="5"</textarea>
                </div>
                <div id="additional-subdiv" class="textarea-subdiv">
                    <label for="additional-textarea">Additional Information:</label>
                    <textarea name="additional-info" id="additional-textarea">value="5"</textarea>
                </div>
            </form>
            <div id="button-div">
                <button id="continue-btn" onclick="createPendingSwitch()">Continue</button>
                <button id="reset-btn" onclick="formReset()">Reset</button>
            </div>
        </div>
    </div>

    <div id="further">
        <ul>
            <li class="ul-header">Know more about us</li>
            <li><a href="">Our Logo</a></li>
            <li><a href="">Our Mission</a></li>
            <li><a href="">Our Vision</a></li>
            <li><a href="">Our Partners</a></li>
            <li><a href="">Testimonies</a></li>
        </ul>
        <ul>
            <li class="ul-header">Take action</li>
            <li><a href="request.html">Receive</a></li>
        </ul>
        <ul>
            <li class="ul-header">Reach out to us</li>
            <li><a href=""><span class="icon-span"></span>Twitter</a></li>
            <li><a href=""><span class="icon-span"></span>Facebook</a></li>
            <li><a href=""><span class="icon-span"></span>Instagram</a></li>
            <li><a href=""><span class="icon-span"></span>YouTube</a></li>
            <li><a href=""><span class="icon-span"></span>9gag</a></li>
        </ul>
    </div>

    <footer>
        2025 Â© Zero-Hunger
    </footer>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Authentication
        import { getAuth, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";


        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAd4UJcWg4hMkvWCFS2LB_f5J0X_eKuAX4",
            authDomain: "zero-hunger-b8414.firebaseapp.com",
            projectId: "zero-hunger-b8414",
            storageBucket: "zero-hunger-b8414.firebasestorage.app",
            messagingSenderId: "361960148895",
            appId: "1:361960148895:web:30eb932276b7c4e3a237aa",
            measurementId: "G-HJST5LWVV6",
            databaseURL: "https://zero-hunger-b8414-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Auth
        const provider = new GoogleAuthProvider();
        const auth = getAuth();
        let currentUser, currentUserUID;

        const checkCurrentUser = (() => {   /* Fetch Current User */
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, see docs for a list of available properties
                    // https://firebase.google.com/docs/reference/js/auth.user

                    currentUser = user;
                    currentUserUID = user.uid;
                    loadUserNav();
                    fetchUserDonations();
                    // ...
                } else {
                    // User is signed out
                    console.log("No user!");
                    forceCurrentUser();
                    // ...
                }
            });
        })();

        const forceCurrentUser = () => {    /* Force-check User */
            if (currentUser == undefined) {
                window.location.href = "index.html";
                sessionStorage.redirectStatus = "true";
            }
        };

        const loadUserNav = () => { /* Check current user, to load navbar details */
            const navLinkWrapper = document.getElementById("nav-link-wrapper");

            if (currentUser != undefined) {
                let avatarSrc;  /* User Avatar Image Source */
                if ((currentUser.photoURL == "") || (currentUser.photoURL == undefined)) {
                    avatarSrc = "./icon/heart.svg";
                } else {
                    avatarSrc = currentUser.photoURL;
                }

                // Load User Details
                navLinkWrapper.innerHTML += `<div id="user-div" onmouseover="showPopunder('user-details-popunder')" onclick="showPopunder('user-details-popunder')">
                <div id="user-details-popunder" class="popunder" onfocus="showPopunder('user-details-popunder')">
                    <p class="popunder-mail"><b>Email: </b>${currentUser.email}</p>
                    <p class="popunder-out"><a href="#" onclick="hidePopunder('user-details-popunder')"">Close</a>
                    <a href="#" onclick="signUserOut()">Sign Out</a></p>
                </div>
                <div id="user-avatar-wrapper">
                    <img src="${currentUser.photoURL}" alt="User Avatar">
                </div>
                <div id="user-details">
                    <p id="user-name">${currentUser.displayName}</p>
                    <p id="user-status"><span id="user-staus-icon"></span> Status</p>
                </div>
            </div>`
            }
            else {
                console.log("No CurrentUser!");

                // Load Sign-In/Log-In instead
                navLinkWrapper.innerHTML += `<div id="sign-in-wrapper">
                <button id="sign-in-button" onclick="showDialog('sign-up-dialog')">Sign In</button>
            </div>`
            }
        };


        window.checkCurrentUser = checkCurrentUser;
        window.forceCurrentUser = forceCurrentUser;
        window.loadUserNav = loadUserNav;


        // Data
        import { getDatabase, ref, set, child, push, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Initialize Realtime Database and get a reference to the service
        const database = getDatabase(app);
        let succesfulDonations;

        // Donations Display
        const placeholderHTML = `<div id="placeholder-div">
                                        <div>
                                            <img id="placeholder-icon" src="./icon/heart.svg" alt="Loading Icon">
                                        </div>
                                        <p>Fetching...</p>
                                    </div>`


        const writeDonation = (donationObj) => {
            const db = getDatabase();
            set(push(ref(db, `Donations`)), {   /* Write donation to general DB */
                succesfulDonation: donationObj
            });
            set(push(ref(db, `Donations-${currentUserUID}`)), {   /* Write donation to user DB */
                succesfulDonation: donationObj
            });
        };

        const submitPending = () => {   /* Submit pending donations */
            if (pendingDonations.length != 0) {
                for (let i = 0; i < pendingDonations.length; i++) {
                    const pendingDonation = pendingDonations[i];

                    const succesfulDonationObj = new succesfulDonation(pendingDonation.type, pendingDonation.unit, pendingDonation.amount, pendingDonation.location, pendingDonation.addInfo);
                    writeDonation(succesfulDonationObj);
                }

                fetchUserDonations();
                succesfulUpdate();

                pendingDonations = [];  /* Empty pending array */
                badgeClear("donations-badge");
            } else {
                console.log("No pending!");
            }
        }

        const fetchUserDonations = () => {
            const db = getDatabase();
            onValue(ref(db, `Donations-${currentUserUID}`), (snapshot) => {
                const data = snapshot.val();

                succesfulDonations = Object.values(data);
                console.log("fetchedUserDonations:", succesfulDonations);
            });
        };

        const succesfulUpdate = () => {   /* Display succesful donations */
            const donationsDisplay = document.getElementById("donation-display"); /* Refresh HTML Element */
            donationsDisplay.innerHTML = placeholderHTML; /* Display placholder */
            fetchUserDonations();

            if (succesfulDonations == undefined) {
                setTimeout(() => {
                    succesfulUpdate();
                    console.log("Fetching...");
                    
                }, 1000);
            } else {
                donationsDisplay.innerHTML = "";    /* Clear Display */
                for (let i = 0; i < succesfulDonations.length; i++) {
                    const donationsDisplay = document.getElementById("donation-display"); /* Refresh HTML Element */

                    donationsDisplay.innerHTML += `<div id="succesful${i}" class="donation-card">
                                <p><b>Food Type: </b>${succesfulDonations[i].succesfulDonation.type}</p>
                                <p><b>Unit Type: </b>${succesfulDonations[i].succesfulDonation.unit}</p>
                                <p><b>Amount: </b>${succesfulDonations[i].succesfulDonation.amount}</p>
                                <p><b>Pick-up Location: </b>${succesfulDonations[i].succesfulDonation.location}</p>
                                <p><b>Additional Information: </b>${succesfulDonations[i].succesfulDonation.addInfo}</p>
                            </div>`;
                }

                const succesfulDonationsBtn = document.getElementById("succesful-donation-btn"); /* Refresh HTML Element */
                succesfulDonationsBtn.classList.add("donation-active-btn");   /* Make button "active"*/
                const pendingDonationsBtn = document.getElementById("pending-donation-btn");
                pendingDonationsBtn.classList.remove("donation-active-btn");    /* "Deactivate" opposing button */
            }
        }


        window.submitPending = submitPending;
        window.fetchUserDonations = fetchUserDonations;
        window.succesfulUpdate = succesfulUpdate;
    </script>

    <script src="script.js"></script>
    <script src="donate.js"></script>
</body>

</html>